<!DOCTYPE html>
<html>
<head>
    <title>Gmail Inbox</title>
    <style>
        body { font-family: sans-serif; }
        .email { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .from, .subject { font-weight: bold; }
        .body { margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>My Emails</h1>
    <div id="status">Loading...</div>
    <div id="emails-container"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const emailsContainer = document.getElementById('emails-container');
        let authWindow = null;
        let pollInterval;

        async function fetchEmails() {
            statusDiv.textContent = 'Checking authentication status...';
            try {
                const response = await fetch('/emails');
                if (response.ok) {
                    if(pollInterval) clearInterval(pollInterval);
                    if (authWindow) authWindow.close();
                    statusDiv.textContent = '';
                    const emailsHtml = await response.text();
                    emailsContainer.innerHTML = emailsHtml;
                } else if (response.status === 401) {
                    statusDiv.innerHTML = 'Authentication required. <a href="/start-auth" target="_blank">Click here to authenticate</a>.';
                    if (!pollInterval) {
                        pollInterval = setInterval(fetchEmails, 2000);
                    }
                } else {
                    if(pollInterval) clearInterval(pollInterval);
                    statusDiv.textContent = `Error: ${await response.text()}`;
                }
            } catch (error) {
                console.error('Error fetching emails:', error);
                statusDiv.textContent = 'Failed to connect to server.';
                if(pollInterval) clearInterval(pollInterval);
            }
        }

        fetchEmails();
    </script>
</body>
</html> 